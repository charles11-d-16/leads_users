<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Techstacks â€” Login Audit</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/audit-logins.css">
</head>
<body data-theme="dark">

<aside id="sidebar">
    <div class="brand">
        <img src="greenlogo2.png" alt="Logo" class="brand-logo">
        Techstacks
    </div>
    
    <div class="nav-group">
        <span class="nav-label">Superadmin</span>
        <a href="dashboard.html" class="nav-item"><i class="bi bi-grid"></i> Dashboard</a>
        <a href="register.html" class="nav-item"><i class="bi bi-person-plus"></i> Register</a>
        <a href="admin-list.html" class="nav-item"><i class="bi bi-people"></i> Admin List</a>
    </div>

    <div class="nav-group">
        <span class="nav-label">Leads</span>
        <a href="inquiry-new.html" class="nav-item"><i class="bi bi-envelope-plus"></i> New Inquiry</a>
        <a href="inquiry-contacted.html" class="nav-item"><i class="bi bi-telephone-outbound"></i> Contacted</a>
        <a href="inquiry-progress.html" class="nav-item"><i class="bi bi-arrow-repeat"></i> In Progress</a>
        <a href="inquiry-cancelled.html" class="nav-item"><i class="bi bi-x-circle"></i> Cancelled</a>
        <a href="inquiry-completed.html" class="nav-item"><i class="bi bi-check-circle"></i> Completed</a>
    </div>

    <div class="nav-group">
        <span class="nav-label">Audit Trail</span>
        <a href="audit-logins.html" class="nav-item"><i class="bi bi-shield-lock"></i> Logins</a>
        <a href="audit-history.html" class="nav-item"><i class="bi bi-journal-text"></i> History</a>
    </div>

    <div class="logout">
        <a href="index.html" class="nav-item" style="color: #ff5e5e;"><i class="bi bi-power"></i> Logout</a>
    </div>
</aside>

<main>
    <div class="header-actions">
        <div style="display: flex; align-items: center; gap: 10px;">
            <button class="btn-icon menu-toggle" onclick="toggleSidebar()"><i class="bi bi-list"></i></button>
            <h2 style="font-weight: 800; font-size: 1.5rem; margin: 0;">&nbsp;<i class="bi bi-shield-lock"></i>&nbsp;&nbsp;&nbsp;Login Audit</h2>
        </div>
        <div style="display: flex; gap: 8px;">
            <button class="btn-icon" onclick="toggleTheme()" title="Toggle Theme" id="themeBtn"><i class="bi bi-moon-stars"></i></button>
        </div>
    </div>

    <div class="table-card">
        <div class="table-scroll">
           <table>
    <thead>
        <tr>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Email</th>
            <th>Role</th>
            <th>IP Address</th>
            <th>Status</th>
            <th>Timestamp</th>
        </tr>
    </thead>
    <tbody id="auditTableBody">
        <tr>
            <td colspan="7" style="text-align: center; color: var(--muted);">Loading records...</td>
        </tr>
    </tbody>
</table>
        </div>
    </div>
</main>
<script>
    // ... your existing toggleSidebar functions ...

    // Function to format date nicely
    const formatDate = (dateString) => {
        const options = { 
            month: 'short', 
            day: 'numeric', 
            year: 'numeric',
            hour: '2-digit', 
            minute: '2-digit' 
        };
        return new Date(dateString).toLocaleDateString('en-US', options);
    };

    // Fetch and Display Login History
   async function fetchLoginHistory() {
    try {
        const response = await fetch('/api/audit/logins'); 
        const data = await response.json();
        
        const tbody = document.getElementById('auditTableBody');
        tbody.innerHTML = ''; 

        if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No login history found.</td></tr>';
            return;
        }

        data.forEach(log => {
    // If user exists, use their name. If not (failed login), show "Unknown / [email]"
    const firstName = log.userId ? log.userId.firstname : "Unknown";
    const lastName = log.userId ? log.userId.lastname : "Unknown";
    const email = log.userId ? log.userId.email : log.attemptedEmail;
    const role = log.userId ? log.userId.role : "N/A";

    const statusClass = log.status === 'Success' ? 'status-success' : 'status-failed';
    const statusIcon = log.status === 'Success' ? 'bi-check-circle' : 'bi-x-circle';

    const row = `
        <tr>
            <td><b style="font-weight: 600;">${firstName}</b></td>
            <td><b style="font-weight: 600;">${lastName}</b></td>
            <td style="color: var(--muted);">${email}</td>
            <td>
                <span style="background: var(--input-bg); padding: 4px 8px; border-radius: 4px; font-size: 11px;">
                    ${role}
                </span>
            </td>
            <td class="ip-text">${log.ipAddress || 'Unknown'}</td>
            <td>
                <span class="status-pill ${statusClass}">
                    <i class="bi ${statusIcon}"></i> ${log.status}
                </span>
            </td>
            <td style="color: var(--muted); font-size: 12px;">${formatDate(log.loginTime)}</td>
        </tr>
    `;
    tbody.innerHTML += row;
});

    } catch (error) {
        console.error('Error fetching logs:', error);
        document.getElementById('auditTableBody').innerHTML = 
            '<tr><td colspan="7" style="text-align: center; color: var(--danger);">Error loading data.</td></tr>';
    }
}
    // Run on page load
    document.addEventListener('DOMContentLoaded', fetchLoginHistory);
</script>
</body>
</html>